---
layout: post
title:  "费用"
---

# 全员应用

Q: 费用报销的整体流程是怎样的？

1. 员工填写费用申请单、借款单、费用报销单，提交单据。
2. 单据提交后，主管可在消息中心（工作流）审批。
3. 主管审批通过后，SSC操作员在共享任务中心处理影像事宜，处理完后，生成出纳的代发单/付款单和总账凭证。
4. 费用会计可查看单据列表和费用报表。

Q: 有些费用或借款需要预先申请，员工应该如何做？

新增人人费用>费用申请单。

费用申请单可通过借款、报销关联生成借款单和费用报销单。

Q: 员工出差需要提前报给领导审批，如何做？

填写出差申请单。

Q: 员工若需要向公司借款出差，如何做？

填写**需要借款的**出差申请单。审批通过后，可下推付款单/代发单进行付款。

**无须借款的**出差申请单在审批通过后，可直接通过商旅平台预定机票、酒店等。

Q: 员工如何发起差旅报销？

填写差旅报销单。

差旅报销单包含行程、费用明细、发票明细等内容，还涉及差旅标准控制、额度控制和费用分摊等。

Q: 员工在哪维护银行账号？

收款信息。

Q: 本人如何委托他人报销？

可新增**委托报销**，设置委/受托人、委托时间和委托范围（单据范围）。

受托人可以替委托人报销。

委托报销单保存后，受托人在录入报销单时，可切换申请人为委托人。此外，受托人可以查到委托人录入的（委托范围内的）单据。

Q: 如果需要对公费报销，例如中介机构费、会议费等，需要如何做。

填写对公报销单。

之所以独立出这种单据，是因为对公费用和个人费用在客户操作场景、业务处理、对收款单位的隔离策略上差异比较大。

# 差旅报销单

Q: 导入发票，如何自动识别对应的差旅项目？

**查询“映射差旅项目(er_rel_expense_ratetype)”**

关键过滤条件: 

1. 单据类型(billtype) = 差旅报销单(value=2)
2. status=c, enable='1'
3. 申请人公司对应的管控策略过滤条件

取tripitem.id值

---

**匹配发票因素**

关键的发票字段有：

1. 税收分类编码(goodsCode)
2. 发票类型(invoiceType)
3. 商品名称(goodsName)
4. 收票公司(buyerOrgName)
5. 出发城市(startcity)
6. 目的城市(destcity)

---

整体入口： MappingItemWithOrgInvoiceServiceImp.process()

# 费用报销单

## 新增

Q-BEGIN

Q: 费用承担公司等字段是如何初始化的？

包括：申请人、创建人、职位、部门、联系方式、申请人公司、费用承担公司、费用承担部门、本位币、单据状态。

Q-END

在 `CoreBaseBillServiceHelper.createNewData(currentUserID)` 中获取初始化值，在 `ErExpenseBaseEdit.loadData` 调用。

部门和费用承担部门的逻辑是：根据当前用户获取非兼职部门。

申请人公司的获取逻辑是：根据部门取对应的行政组织。

`OrgUnitServiceHelper.getCompanyFromOrg(deptId)`

费用承担公司的获取逻辑是：根据部门取对应的核算组织。

`OrgUnitServiceHelper.getCompanyByAdminOrg(deptId, isBizUnit=true)`

币别的逻辑是：根据费用承担公司，到系统参数取"单据获取本位币组织"的值，根据是按申请人公司还是单头费用承担公司，取对应公司的本位币。

该初始化逻辑还处理了申请人、费用承担部门、币别等的初始化。

Q: 费用明细分录的费用承担公司、费用承担部门和币别是如何初始化的？

默认从单头携带。

`web.ExpenseEntryPlugin.afterCreateNewData`

Q: 费用项目是如何过滤的？

1. 管控策略
2. 审核、可用
3. 费用项目关联单据
4. 费用项目关联部门

Q: 修改费用项目会关联带出什么信息？

有预算余额、税率、是否抵扣、抵扣税额、可用额度、额度控制部门。

Q: 默认带出的收款信息逻辑是什么？

查询过滤条件：

1. 根据当前用户，按创建人或收款人过滤
1. 再过滤默认的
1. 并且是可用的

如果查出多条：

1. 优先取创建人=收款人的
2. 其次取收款人=当前用户的
3. 最后才取创建人=当前用户的

PayeeServiceHelper.getDefaltAccount(userId)

---

查询字段有收款人、银行账号、（银行账号4位、银行账号前后4位）、收款银行、银行logo、银行卡背景图片、账户名称等。

PayeeServiceHelper.commonSelectFields

---

默认支付方式（结算方式, bd_settlementType）的获取：

1. 默认的
2. 可用的
3. 状态=c
   
查询字段有id、name、number、settlementtype

Q: 录入费用项目如何带出可用额度？

可用额度是计算出来的，若本单据是B、C两种状态，则计算可用额度排除当前单。

```
EmpQuotaCtrlMode.getBalanceAmount(quotaAmountBO)
ReimburseAmountControlFormPlugin.showExpenseBalanceAmount()
```

---

**查询总额度**

首先，根据以下条件查询个人额度表：

1. 公司，一般是申请人公司
1. 人员
1. 费用项目
1. 币别
1. 年度
1. 状态=已审核

QuotaQueryService.queryEmpQuotaAmount(reimAmountBO)

查询出12个月份、4个季度和年度总额。

如果是按月控制，则取对应月份的金额。

这里还涉及到释放的范畴，此处先不涉及。

代码入口： QuotaQueryService.getEmpQuotaAmount(reimAmountBO)

---

**查询已用额度**

参考问题： 本年已用额度是如何计算的？

---

用总额度减去已用额度，再和0相比取较大者，返回。

## 列表

Q: 费用报销单的列表是如何过滤的？

通过特殊数据权限，过滤出申请单等于自己的单据。

# 对公报销单

Q: 对公报销单如何上拉立项？

当申请人公司对应的系统参数“对公单据上拉单据按供应商过滤”为是时，需要先录入往来单位再选择立项单。

过滤条件：

1. 不存在在途状态的下游借款单和预付单（单据状态为A/B/C/D/E/F）

# 个人额度表

Q: 个人额度表的人员选择范围是怎样的？

如果公司没有和职员强关联（系统参数 isuserrelatecompany），则无任何过滤条件。

否则，先确定组织范围。看费用全局配置（er_reimburseamount.includeSubCompany），如果为true，则取自身及下级所有的行政组织，否则仅取自身。

最后，按分录的部门包含在上述的组织范围内为条件，查询符合条件的人员。

ErPersonReimburseAmountPlugin.getEmployeeQFilter()

Q: 个人额度表的费用项目选择范围是怎样的？

1. 额度控制=员工额度控制。这个过滤是在元数据里配置的。
1. 叶子节点，状态=C，并且可用。

LeafExpenseItemSelectListener.beforeF7Select(event)

Q: 公司结转如何进行？

首先，列表选定的个人额度表，必须是已审核的，并且公司和额度控制方法都相同的。

ErReimburseAmountListPlugin.afterDoOperation(event), operKey=comcarryforward

然后，一条一条来。

判断转入公司是否重复：按目标公司、币别、年度、费用项目、职员，确认是否存在数据。

ErQuotaCarryForwardPlugin.quotaCarryForward()

---

举个例子说明公司结转是做什么的：

假设有一条个人额度数据（省略无关字段）：

公司 | 1季度 | 2季度 | 3季度 | 4季度 
--- | --- | --- | --- | ---
A | 110 | 110 | 110 | 110 

结转到B公司，转出季度第2季，结果变为：

公司 | 1季度 | 2季度 | 3季度 | 4季度 
--- | --- | --- | --- | ---
A | 110 | 0 | 0 | 0 
B | 0 | 110 | 110 | 110 

---

根据不同的额度控制方法，采用不同的策略。

如果是按年控制或累计控制，则按区间【结转月份,12月】，每个月都确认额度是否已使用，若已使用则停止结转，否则就将该月的额度累加到一个临时金额变量里。

确认额度是否已使用的方法是，取得指定时间范围内的额度使用值是否大于0.使用额度值的获取方法是: service.getUserReimbursedAmountBetween(compId, empId, expItemId, currencyId, beginDate, endDate, excludeReimBillIds)

按季度控制的逻辑也一样，只是一个一个季度来循环处理，并且获取额度值的方法是 service.getReimbursedAmountByMonth(compId, empId, expItemId, currencyId, 季度，排除的报销单ids)

若目标公司全年的已用额度大于结转总额，则停止结转。*不过有了前面的“转入公司是否重复”的校验，这里的校验应该是不需要的，因为目标公司没有维护个人额度表，根本就不可能使用这个费用项目填费用报销单，费用报销单提交时会校验超出额度的。*

Q: 跨年结转功能是什么？

跨年结转支持将以往年度的未使用额度结转到当年使用。

增加后台字段“是否已年度结转”，年度结转后，该字段置为是。该字段若为是，则不可再进行额度结转。

列表界面，年度选择当年或当前以后，跨年结转按钮隐藏；若选择不限，则结转年度为上一年；否则结转年度为所选年度。

执行年度结转前给予提醒：结转后不支持反结转，请确认是否要执行结转操作？

结转之前对所选数据执行统一检查：

1. 状态=已审核
1. 所选数据的额度控制方式需要一致

若额度控制方式不为“按年控制”，则弹出界面由用户选择一些选项：

1. 界面展示时，将列表选择的所选年度带入到转出年度字段，并且可编辑；同时有转入年度字段，默认本年且锁定。
1. 若控制方式为“按月控制”或“累计控制”，则结转方式可下拉选择：1. 结转到对应期间；2.全部结转到指定月份，并在旁边显示月份录入控件。
1. 若控制方式为“按季控制”，则结转方式可下拉选择：1. 结转到对应期间；2.全部结转到指定季度，并在旁边显示季度录入控件。

对每条记录执行结转前检查：

1. 本年需存在与记录在“公司、费用项目、职员、币别”4个维度都相同的数据。
1. 年度总额度-整年已用额度 大于 0

按额度控制方式分别采用不同的结转策略：

1. 按年结转

    1. 计算结转额度 = 年总额度-整年已用额度
    1. 将转出额度单的年总额度更新为整年已用额度
    1. 将转入额度单的年总额度更新为自身值加上结转额度

1. 按季度结转

    1. 循环4季
    1. 根据转出额度单，算出每一季的季度已用额度
    1. 计算转出额度单的季度结转额度 = 季度总额度-季度已用额度
    1. 将转出额度单的季度总额度更新为季度已用额度
    1. 如果结转方式为结转到对应期间，将转入额度单的季度总额度更新为自身加上季度结转额度
    1. 退出循环
    1. 如果结转方式为结转到指定期间，则将年结转额度累加到转入额度单的指定期间字段
    1. 将转出额度单的年总额度更新为整年已用额度；将转入额度单的年总额度更新为自身加上年结转额度

1. 按月或累计结转

    1. 循环12月
    1. 根据转出额度单，算出每一月的月度已用额度
    1. 计算转出额度单的月度结转额度 = 月度总额度-月度已用额度
    1. 将转出额度单的月度总额度更新为月度已用额度
    1. 如果结转方式为结转到对应期间，将转入额度单的月度总额度更新为自身加上月度结转额度
    1. 退出循环
    1. 如果结转方式为结转到指定期间，则将年结转额度累加到转入额度单的指定期间字段
    1. 将转出额度单的年总额度更新为整年已用额度；将转入额度单的年总额度更新为自身加上年结转额度


# 费用分摊

Q: 员工报销涉及多部门，或跨月，如何分摊费用？

员工填报销单时，填写费用明细和分摊信息。填写分摊信息的过程中可预览摊销明细。报销单提交时系统据此按比例或金额平均分摊费用，生成摊销明细，同时将报销单单头后台标识“是否已分摊”置为是。

Q: 员工报销时没有填写分摊信息，财务人员审单时如何执行事后费用分摊？

在报销单审核通过或已付款后，财务人员可对该报销单执行“费用分摊”操作，该操作会生成费用分摊单。

# 费用系统控制

Q: 人人费用/差旅是全员应用，如何设置只在某些组织范围内才可用，或者对某些组织屏蔽？

使用 【报销设置 > 试点单位维护】 功能。

Q: 报销政策变更后，如何提醒用户？

使用 【报销设置 > 报销提醒设置】 功能。

Q: 如何设置员工的差旅报销填写方式（表格式或者卡片式）

配置参数： "系统服务云>配置工具>系统参数>财务云>费用核算>人人差旅>差旅报销填写方式".

需要先选好组织再配置。

卡片式差旅报销单可以按行程归类费用明细。

Q: 如何设置员工的差旅报销金额标准和控制方式？

**差旅标准**将员工、出差地域、交通/住宿/补助金额标准关联起来，员工发起差旅报销时，若报销金额超标，可根据参数设置情况驳回报销、给予提示或者不控制处理。

需要在多个地方进行设置：

1. 在**系统参数**可以设置是否启用差旅标准、住宿补助和交通工具的控制方式，补助天数的计算方式。
2. 定义**差旅项目**：按类目细分差旅费用，例如机票、火车、住宿等
3. **报销级别**：仅是个名称。
4. **报销级别设置**：按员工的维度，将公司和报销级别绑定起来。
5. **出差地域**：可选择多个城市，将所选城市归集起来管理。
6. **住宿补助标准**：按报销级别维度，归集多个（差旅项目-出差地域-标准金额）的组合。
7. **交通工具标准**：按报销级别设置交通工具的标准（如飞机下有头等舱、经济舱等）
8. **差旅报销单提交时**，系统根据报销人的报销级别设置，找到相关信息，结合单据上的行程和费用信息，做出相应控制。

梳理一下控制逻辑：

1. 由报销单的公司、员工找到报销级别设置
2. 由报销级别设置找到报销级别
3. 由报销级别和报销单的差旅项目，找到住宿补助/交通工具标准
4. 若报销单填写的金额不满足相应差旅标准的金额，则按系统参数设置做出相应控制

Q: 如何对员工/部门的日常费用进行额度控制，如对员工的手机话费、部门活动费进行额度控制？

功能分别是报销标准下的**个人/部门额度表**，下面以个人额度表为例。

**操作前提**

第一步： 设置系统参数：

1. 费用总体下的"个人/部门额度控制范围"，可多选设置费用报销单和差旅报销单。
2. 人人费用下设置"是否启用额度控制"为是。
3. 设置"额度超额控制方式"（严格控制/仅提示）。
4. "可用额度显示位置"（费用明细表格显示/费用明细卡片头显示）。

第二步： 设置费用项目的**额度信息**（名称其实应该叫额度控制）。

1. 额度控制：无控制、员工/部门额度控制
2. 控制类型：定额控制（？）、混合控制（？）
3. 累计/按月/按季/按年控制
4. 额度控制次数（？）

**操作步骤**

打开个人额度表，里面的表头可录入公司、部门、职员（部门额度表没有这一项）、费用项目、年度等。

接着可分别填写"1到12月的额度金额值"。

填完后在列表界面审核。

Q: 之前设定的个人额度，如何对指定的一些费用项目，释放一部分额度控制？

使用功能： 报销标准 > 额度释放方案。

这个功能仅对按月控制/累计控制的费用项目有效（待确认），效果是增加当前月份的可用额度。

录入的信息有：

1. （可多选）费用项目
1. 释放日期（可填1 到 31）
1. 释放比例（可填1-100）

# 发票云集成

Q: 如何判断系统是使用内部发票云还是集成外部发票云？

查看**费用全局配置**，搜索key： `invoicecloud.invoicecloudxh`， 为true就是使用内部发票云。

Q: 报销单界面如何支持导入发票？

1. 在**费用全局配置**配置这个key：`invoicecloud.configpattern`，值区分组织和集团。
2. 进入【系统服务云>基础资料>财务数据>发票云配置/（集团）】，给**费用承担公司**新增一条配置数据。

Q: 报销导入发票时，如何自动匹配费用/差旅项目？

todo

Q: 报销导入多张发票时，如何按特定维度合并多张发票到一条费用明细？

进入 【发票设置 > 发票合并规则】，按需修改对应发票类型的合并规则。

合并规则支持合并同一张发票的多条明细，也支持跨发票合并。

合并条件支持勾选预置的，例如：

1. 税号相同
2. 开票公司相同
3. 费用/差旅项目相同
4. 等等

也支持配置自定义合并条件。

Q: 员工报销时还拿不到发票，报销单提交后才拿到，员工如何补交发票？

填写报销单时，关闭智能发票报销按钮，打开发票后补按钮。
后续，在报销单列表界面过滤出发票后补的单据。
todo

Q: 发票集成日志是干什么用的？

费用单据在执行保存、提交、工作流审核、删除操作时要和发票云进行网络交互，有可能存在网络异常，私有云客户中经常如此。如果在批量审单时发生网络异常，会导致工作流批量挂起。虽然可以通过重新激活工作流解决，但这种偶发问题由于发生频率太高，用户体验不好，因此考虑将发票云交互和工作流审核这两个动作分开，当前者失败时，不影响后者正常完成，而是将失败的请求url、参数和响应结果等记录到一张日志表里，后续由定时任务或者手工重新触发执行。

发票集成日志记录的异常：

1. 网络异常
2. 发票云返回的处理失败结果（即 errorcode 不等于 0000 的结果）

发票集成日志不记录的异常：

1. 非上述异常，即我们代码自己的异常。

发票集成日志涉及两张表：

1. 发票集成日志(er_invoiceasynclog)
2. 单据操作(er_operation)

一条定时任务（调度计划，每晚11点执行）： em_invoiceasynclog_SKDP_S

为了避免重复报销，报错、提交操作的发票云交互不能和操作本身分开，而审核操作则可分开。这一点通过在“单据操作”表中的“是否拦截”标识字段区分。

由于商旅付款申请单和其它报销单的操作标识不一致，不采用通过操作标识识别操作，而操作插件本身是相对固定的，采用操作插件全类名来识别操作。

待改善点：

1. 每趟定时任务清除3个月以前的成功日志
2. 失败次数超过一定数量的日志如何处理？后续考虑改用平台的最终一致性框架实现。

Q: 发票信息-是否连号，赋值逻辑是啥？

使用AWS：

导入发票后，在发票云传回的json中，如果存在verifyResult（一个List），且里面的某个元素的key是sequenceNum，那么赋值为1（连号）否则赋值2（不连号）。

# 财务核算

Q: 费用会计如果想处理财务相关的工作，例如查询单据、关联付款、生成凭证、报表分析等，应该使用什么应用功能？

费用核算

Q: 费用有哪些核算功能？

在【单据中心】菜单下，挂有如下子菜单：

**人人费用**

1. **费用申请单**：可查询费用申请单。
1. **费用报销单**：可查询费用报销单，并进行付款（生成代发单）、费用预提？、费用分摊？、生成凭证。
1. **额度申请单**：可查询额度申请单，并执行生成额度（？）。
1. **借款单**：可进行付款、还款（生成还款单）、手动付款/取消付款（？）等。

_代发单是出纳的单据_

**人人差旅**

1. **出差申请单**：支持付款（生成代发单？）、生成凭证等。
1. **差旅报销单**：支持付款（生成代发单？）、生成凭证等。

**对公费用**

1. **对公报销单**：支持付款（生成代发单？）、费用预提？、费用分摊？、生成凭证等。

**费用公共**

1. **还款单**：支持收款（生成收款单？）等
1. **费用分摊单**
1. **费用预提单**

# 报表查询

Q: 费用会计人员如何统计和监控部门/员工的费用额度？

使用报表查询 > 个人额度查询/部门额度查询

可查看一定时间范围内的年总额度、本年已用额度、本期额度、本期可用额度、未释放额度（？）等。

Q: 如何查看系统的报销单据所关联的发票信息？

使用报表查询 > 发票查询

## 个人额度查询

Q: 个人额度查询是查什么数据？

根据用户所配置的查询条件：

1. 公司
1. 年份
1. 单据类型（费用报销单、差旅报销单）
1. 费用项目

查询个人的额度使用情况信息，比如：

1. 控制次数 = 费用项目.额度控制次数
1. 年总额度
1. 本年已用额度
1. 本期额度
1. 本期可用额度
1. 未释放额度

AbstractAmountQueryService.processRowDataForPersonal(row, reportQueryParam)

Q: 费用项目上，跟额度控制相关的属性是什么？

1. 额度控制（0无控制、1员工额度控制、2部门额度控制）
1. 控制类型（1定额控制、2混合控制）
1. 额度控制方法：A累计控制、B按月控制、E按季、C按年
1. 额度控制次数

Q: 年总额度是如何计算的？

按照用户配置的查询条件，查询状态=已审的个人额度表(er_reimburseamount)，取其年总额度(totalamount)字段。

FinanceAmountQueryReport.query(queryParam, obj)

Q: 额度计算的参数对象 QuotaAmountBO 是如何构造的？

**从个人额度表带出的基本信息**

1. 公司
1. 人员或部门
1. 单据类型范围（费用报销单、差旅报销单）
1. 费用项目id
1. 额度控制(ctrlModel)，写死为个人额度
1. 额度控制方法，从费用项目带出

AbstractAmountQueryService.processRowDataForPersonal(row, queryParam)

---

**查询字段设置**

按公司获取系统参数“个人额度币种控制”的值（0按原币控制、1按本币控制），根据不同的值，设置费用报销单和差旅报销单的币别、金额所对应的字段。

参数 | 费用报销单 | 差旅报销单
-- | -- | --
按原币控制 | 费用明细.币别 | 行程信息.差旅明细.币别
- | 费用明细.核定金额 | 行程信息.差旅明细.核定金额
按本币控制 | 本位币别 | 本位币别
- | 费用明细.核定金额（本位币） | 行程信息.差旅明细.核定金额（本位币）

QuotaCtrlUtil.genQuotaCurrency(bo,原/本币,原币id，本币id)

---

**其他信息**

1. 日期范围(happenDatePeriod)，从当前年度1月1日到当前年度
2. isByFreedRatio

AbstractAmountQueryService.processRowDataForPersonal(row, queryParam)

Q: 本年已用额度是如何计算的？

**查询二开额度**

标准实现是0。

```
EmployeeReimAmountServiceImpl.getEmployeeReimbursedAmountBetween(...)
DailyAmountUtils.getEmployeeReimbursedAmountBetween(...)
EmpQuotaCtrlMode.getReimedAmount(...)
```

---

判断费用全局配置“额度查询逻辑是否需要走标准逻辑”，若否，则直接返回二开额度，否则**走标准逻辑算出额度，跟二开额度相加，作为最终结果返回**。

EmpQuotaCtrlMode.getReimedAmount(quotaAmountBO)

---

**标准逻辑**

就是根据查询条件，查询费用报销单和（或）差旅报销单的数据。

查询费用报销单的关键过滤条件有：

1. 申请人公司（这个优先根据费用全局配置 reimctl.person.ctlCompanyField 来定）
2. 单据状态：B已提交、C审核中、E审核通过、F等待付款、G已付款、I关闭
3. 费用项目
4. 费用明细.报销人
5. 费用发生日期 在 日期范围内
6. quotaAmountBO的费用报销单币别字段=quotaAmountBO的币别

拼完过滤条件后，查询费用报销单的金额（quotaAmountBO的费用报销单金额字段），合计，返回。

差旅报销单也是类似的逻辑，关键过滤条件有：

1. 申请人公司
1. 单据状态
1. 行程信息.差旅明细.出差人.fbasedataid
1. 行程信息.差旅明细.费用项目
1. 行程信息.差旅明细.费用归属月份
1. quotaAmountBO的差旅报销单币别字段=quotaAmountBO的币别